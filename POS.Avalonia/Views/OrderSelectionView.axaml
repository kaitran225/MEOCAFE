<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:POS.Avalonia.ViewModels"
             xmlns:models="using:POS.Core.Models"
             xmlns:controls="using:POS.Avalonia.Controls"
             x:Class="POS.Avalonia.Views.OrderSelectionView"
             x:Name="Root"
             x:DataType="vm:OrderSelectionViewModel">
  <Grid>
    <Grid RowDefinitions="*" ColumnDefinitions="*,400">
    <!-- Left: sticky category strip, search, then product grid -->
    <Grid Grid.Row="0" Grid.Column="0" Margin="4" RowDefinitions="Auto,Auto,*">
      <!-- Category tabs always visible (sticky) -->
      <ListBox Grid.Row="0" ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory}"
               Background="Transparent" BorderThickness="0" Padding="0" MinHeight="0" Classes="CategoryTabs">
        <ListBox.ItemsPanel>
          <ItemsPanelTemplate>
            <StackPanel Orientation="Horizontal" Spacing="2"/>
          </ItemsPanelTemplate>
        </ListBox.ItemsPanel>
        <ListBox.ItemTemplate>
          <DataTemplate DataType="models:Category">
            <Border Padding="10,5" Margin="0,0,0,1" CornerRadius="4,4,0,0" Background="Transparent" BorderThickness="1,1,1,0" BorderBrush="Transparent">
              <TextBlock Text="{Binding Name}" FontSize="12" FontWeight="SemiBold"/>
            </Border>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>
      <TextBox Grid.Row="1" Watermark="Search" Text="{Binding SearchTerm}" Padding="8,6" MinHeight="32" FontSize="12" Margin="0,4,0,0"/>
      <!-- Product grid: larger cards (120–140px), scroll only products -->
      <ScrollViewer Grid.Row="2" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" Margin="0,4,0,0">
        <ItemsControl ItemsSource="{Binding FilteredMenuItems}">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <WrapPanel/>
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>
          <ItemsControl.ItemTemplate>
            <DataTemplate DataType="models:MenuItem">
              <Button Width="160" Padding="0" Margin="6" Background="Transparent" BorderThickness="0"
                      Command="{Binding #Root.DataContext.SelectProductForCustomizeCommand}" CommandParameter="{Binding}">
                <Border Padding="12" Background="{StaticResource SurfaceBrush}"
                        CornerRadius="{DynamicResource CornerRadius8}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                  <StackPanel HorizontalAlignment="Center" Spacing="8">
                    <TextBlock Text="{Binding Name}" FontSize="{DynamicResource BodyFontSize}" FontWeight="SemiBold"
                               Foreground="{StaticResource OnSurfaceBrush}" TextWrapping="Wrap" TextAlignment="Center" MaxWidth="136" TextTrimming="CharacterEllipsis"/>
                    <Border Width="80" Height="80" CornerRadius="{DynamicResource CornerRadius8}"
                            Background="{StaticResource SecondaryLightBrush}" HorizontalAlignment="Center">
                      <TextBlock Text="☕" FontSize="36" HorizontalAlignment="Center" VerticalAlignment="Center"
                                 Foreground="{StaticResource SecondaryBrush}" Opacity="0.9"/>
                    </Border>
                    <TextBlock Text="{Binding SellPrice, StringFormat={}{0:N0} ₫}" FontSize="{DynamicResource CaptionFontSize}"
                               Foreground="{StaticResource SecondaryBrush}" HorizontalAlignment="Center"/>
                  </StackPanel>
                </Border>
              </Button>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>
    </Grid>
    <!-- Right: standalone bill tab bar above, then bill section -->
    <StackPanel Grid.Row="0" Grid.Column="1" Margin="{DynamicResource Margin8}" Spacing="0">
      <!-- Standalone bill tab strip above the bill section -->
      <Border Background="{StaticResource SurfaceBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1,1,1,0"
              CornerRadius="8,8,0,0" Padding="8,6">
        <Grid ColumnDefinitions="*,Auto,Auto,Auto">
          <ListBox Grid.Column="0" ItemsSource="{Binding Bills}" SelectedIndex="{Binding CurrentBillIndex}"
                   Background="Transparent" BorderThickness="0" Padding="0" Margin="0,0,8,0" Classes="BillTabs">
            <ListBox.ItemsPanel>
              <ItemsPanelTemplate>
                <StackPanel Orientation="Horizontal" Spacing="2"/>
              </ItemsPanelTemplate>
            </ListBox.ItemsPanel>
            <ListBox.ItemTemplate>
              <DataTemplate DataType="vm:BillViewModel">
                <Border Padding="10,5" Margin="0,0,0,1" CornerRadius="4,4,0,0" Background="Transparent" BorderThickness="1,1,1,0" BorderBrush="Transparent">
                  <TextBlock Text="{Binding Label}" FontSize="12" FontWeight="SemiBold"/>
                </Border>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
          <Button Grid.Column="1" Command="{Binding HoldBillCommand}" Padding="8,4" Margin="0,0,4,0" ToolTip.Tip="Hold">
            <PathIcon Data="{StaticResource IconBookmark}" Width="18" Height="18"/>
          </Button>
          <Button Grid.Column="2" Command="{Binding OpenRecallCommand}" Padding="8,4" Margin="0,0,4,0" ToolTip.Tip="Recall">
            <PathIcon Data="{StaticResource IconHistory}" Width="18" Height="18"/>
          </Button>
          <Button Grid.Column="3" Command="{Binding NewBillCommand}" Padding="8,4" MinWidth="36" ToolTip.Tip="New bill">
            <PathIcon Data="{StaticResource IconAdd}" Width="20" Height="20"/>
          </Button>
        </Grid>
      </Border>
      <!-- Bill section (customer, lines, totals, actions) -->
      <Border Background="{StaticResource BackgroundBrush}" CornerRadius="0,0,8,8" Padding="{DynamicResource Margin8}"
              BorderBrush="{StaticResource BorderBrush}" BorderThickness="1,0,1,1">
        <StackPanel Spacing="{DynamicResource Spacing4}">
          <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,4">
            <Button Command="{Binding OpenCustomerSearchCommand}" Padding="8,4" ToolTip.Tip="Customer">
              <PathIcon Data="{StaticResource IconPerson}" Width="18" Height="18"/>
            </Button>
            <Button Command="{Binding OpenNewCustomerCommand}" Padding="8,4" ToolTip.Tip="New customer">
              <PathIcon Data="{StaticResource IconPerson}" Width="18" Height="18"/>
            </Button>
            <TextBlock Text="{Binding CustomerDisplayText}" VerticalAlignment="Center" FontSize="{DynamicResource BodyFontSize}" IsVisible="{Binding HasCustomer}"/>
            <Button Command="{Binding ClearCustomerCommand}" Padding="6,4" IsVisible="{Binding HasCustomer}" ToolTip.Tip="Clear customer">
              <PathIcon Data="{StaticResource IconDelete}" Width="16" Height="16"/>
            </Button>
            <Button Content="Redeem points" Command="{Binding OpenRedeemPointsCommand}" Padding="8,4" IsVisible="{Binding HasCustomer}"/>
          </StackPanel>
          <StackPanel Spacing="4" Margin="0,0,0,4">
            <TextBlock Text="Service type" FontSize="{DynamicResource CaptionFontSize}" Foreground="{StaticResource OnSurfaceMutedBrush}"/>
            <StackPanel Orientation="Horizontal" Spacing="4">
              <Button Content="Dine-in" Command="{Binding SetServiceTypeCommand}" CommandParameter="Dine-in" Padding="8,4" FontSize="12"/>
              <Button Content="Takeaway" Command="{Binding SetServiceTypeCommand}" CommandParameter="Takeaway" Padding="8,4" FontSize="12"/>
              <Button Content="Delivery" Command="{Binding SetServiceTypeCommand}" CommandParameter="Delivery" Padding="8,4" FontSize="12"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="4">
              <TextBlock Text="Table:" VerticalAlignment="Center" FontSize="12"/>
              <ItemsControl ItemsSource="{Binding Tables}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="4"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate DataType="models:Table">
                    <Button Content="{Binding Name}" Command="{Binding #Root.DataContext.SetTableCommand}" CommandParameter="{Binding}" Padding="6,4" FontSize="11"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
            <StackPanel Spacing="4">
              <TextBox Text="{Binding DeliveryAddress}" Watermark="Delivery address" Padding="6,4" FontSize="12"/>
              <StackPanel Orientation="Horizontal" Spacing="4">
                <TextBox Text="{Binding DeliveryFeeText}" Watermark="Fee" Width="60" Padding="6,4" FontSize="12"/>
                <Button Content="Apply delivery" Command="{Binding ApplyDeliveryToCurrentBillCommand}" Padding="6,4" FontSize="12"/>
              </StackPanel>
            </StackPanel>
          </StackPanel>
          <TextBlock Text="{Binding CurrentBill.Label, StringFormat='Current bill: {0}'}" FontWeight="{StaticResource TitleFontWeight}" FontSize="{DynamicResource SubtitleFontSize}"/>
          <ScrollViewer MaxHeight="220">
            <ItemsControl ItemsSource="{Binding CurrentBill.Lines}">
              <ItemsControl.ItemTemplate>
                <DataTemplate DataType="vm:BillLineViewModel">
                  <Border Padding="12,10" Margin="0,3" Background="{StaticResource SurfaceBrush}"
                          CornerRadius="{DynamicResource CornerRadius4}">
                    <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto">
                      <Button Grid.Column="0" Command="{Binding #Root.DataContext.CustomizeLineCommand}" CommandParameter="{Binding}"
                              Background="Transparent" BorderThickness="0" Padding="0" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                          <TextBlock Text="{Binding ProductName}" VerticalAlignment="Center" FontSize="{DynamicResource BodyFontSize}" TextTrimming="CharacterEllipsis"/>
                          <TextBlock Text="{Binding Quantity}" VerticalAlignment="Center" FontSize="{DynamicResource CaptionFontSize}" Foreground="{StaticResource OnSurfaceMutedBrush}"/>
                          <TextBlock Text="{Binding LineTotal, StringFormat={}{0:C0}}" VerticalAlignment="Center" FontSize="{DynamicResource BodyFontSize}"/>
                        </StackPanel>
                      </Button>
                      <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center" Margin="8,0">
                        <Button Command="{Binding DecrementQtyCommand}" Padding="6,6" MinWidth="36" MinHeight="36" ToolTip.Tip="Decrease">
                          <PathIcon Data="{StaticResource IconSubtract}" Width="14" Height="14"/>
                        </Button>
                        <TextBlock Text="{Binding Quantity}" VerticalAlignment="Center" MinWidth="28" TextAlignment="Center"/>
                        <Button Command="{Binding IncrementQtyCommand}" Padding="6,6" MinWidth="36" MinHeight="36" ToolTip.Tip="Increase">
                          <PathIcon Data="{StaticResource IconAdd}" Width="14" Height="14"/>
                        </Button>
                      </StackPanel>
                      <Button Grid.Column="2" Command="{Binding #Root.DataContext.CustomizeLineCommand}" CommandParameter="{Binding}" Padding="8,6" MinHeight="36" ToolTip.Tip="Customize">
                        <PathIcon Data="{StaticResource IconEdit}" Width="16" Height="16"/>
                      </Button>
                      <Button Grid.Column="3" Command="{Binding #Root.DataContext.RequestVoidLineCommand}" CommandParameter="{Binding}" Padding="8,6" MinHeight="36" ToolTip.Tip="Void line">
                        <PathIcon Data="{StaticResource IconDelete}" Width="16" Height="16"/>
                      </Button>
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>
          <!-- Sticky totals at bottom of bill panel -->
          <Border Padding="{DynamicResource Margin8}" Margin="0,8,0,0" Background="{StaticResource SurfaceBrush}" CornerRadius="{DynamicResource CornerRadius4}">
            <StackPanel Spacing="4">
              <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0" Text="Subtotal" FontSize="{DynamicResource BodyFontSize}"/>
                <TextBlock Grid.Column="1" Text="{Binding CurrentBill.Subtotal, StringFormat={}{0:C0}}" FontSize="{DynamicResource BodyFontSize}"/>
              </Grid>
              <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0" Text="Discount" FontSize="{DynamicResource BodyFontSize}"/>
                <TextBlock Grid.Column="1" Text="{Binding CurrentBill.DiscountAmount, StringFormat={}{0:C0}}" FontSize="{DynamicResource BodyFontSize}"/>
              </Grid>
              <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0" Text="Tax" FontSize="{DynamicResource BodyFontSize}"/>
                <TextBlock Grid.Column="1" Text="{Binding CurrentBill.TaxAmount, StringFormat={}{0:C0}}" FontSize="{DynamicResource BodyFontSize}"/>
              </Grid>
              <Grid ColumnDefinitions="*,Auto" Margin="0,4,0,0">
                <TextBlock Grid.Column="0" Text="Total" FontWeight="{StaticResource TitleFontWeight}" FontSize="{DynamicResource SubtitleFontSize}"/>
                <TextBlock Grid.Column="1" Text="{Binding CurrentBill.GrandTotal, StringFormat={}{0:C0}}" FontWeight="{StaticResource TitleFontWeight}" FontSize="{DynamicResource SubtitleFontSize}"/>
              </Grid>
            </StackPanel>
          </Border>
          <Button Content="Pay" Command="{Binding PayCommand}" HorizontalAlignment="Stretch" MinHeight="52" Padding="20,14"
                  CornerRadius="{DynamicResource CornerRadius8}" FontSize="{DynamicResource BodyFontSize}" FontWeight="SemiBold" Classes="primary"/>
          <Button Command="{Binding OpenMergeDialogCommand}" HorizontalAlignment="Stretch" Padding="8,4" Margin="0,4,0,0" CornerRadius="{DynamicResource CornerRadius8}" ToolTip.Tip="Merge another bill into current">
            <TextBlock Text="Merge bill" FontSize="{DynamicResource CaptionFontSize}"/>
          </Button>
          <Button Command="{Binding RequestVoidBillCommand}" HorizontalAlignment="Stretch" Padding="8,4" Margin="0,4,0,0" CornerRadius="{DynamicResource CornerRadius8}" ToolTip.Tip="Void bill">
            <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
              <PathIcon Data="{StaticResource IconDelete}" Width="16" Height="16"/>
              <TextBlock Text="Void bill" FontSize="{DynamicResource CaptionFontSize}"/>
            </StackPanel>
          </Button>
        </StackPanel>
      </Border>
    </StackPanel>
    </Grid>

    <!-- Dialog: Customize line – two columns (left: image/name/price/qty/total; right: options); footer: Add to order + Close -->
    <Border x:Name="CustomizationOverlay" IsVisible="{Binding IsCustomizationOpen}" Background="{StaticResource OverlayDimBrush}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ZIndex="100">
      <Border x:Name="CustomizationDialogPanel" HorizontalAlignment="Center" VerticalAlignment="Center" Background="{StaticResource SurfaceBrush}"
              Padding="24" CornerRadius="{DynamicResource CornerRadius12}" MinWidth="480" MaxWidth="560" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1"
              Focusable="True">
        <Border.KeyBindings>
          <KeyBinding Gesture="Enter" Command="{Binding ConfirmCustomizationCommand}"/>
          <KeyBinding Gesture="Escape" Command="{Binding CloseCustomizationCommand}"/>
        </Border.KeyBindings>
        <StackPanel Spacing="20">
          <TextBlock Text="Customize line" FontSize="{DynamicResource SubtitleFontSize}" FontWeight="{StaticResource SubtitleFontWeight}" Foreground="{StaticResource OnSurfaceBrush}"/>
          <Grid ColumnDefinitions="*,*">
              <StackPanel Grid.Column="0" Spacing="12" Margin="0,0,12,0">
            <!-- Left: image, name, unit price, quantity stepper, line total -->
              <Border Width="120" Height="120" CornerRadius="8" Background="{StaticResource SecondaryLightBrush}" HorizontalAlignment="Center">
                <TextBlock Text="☕" FontSize="48" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource SecondaryBrush}" Opacity="0.9"/>
              </Border>
              <TextBlock Text="{Binding CustomizationLine.ProductName}" FontSize="{DynamicResource BodyFontSize}" FontWeight="SemiBold" Foreground="{StaticResource OnSurfaceBrush}" TextWrapping="Wrap"/>
              <TextBlock Text="{Binding CustomizationLine.UnitPrice, StringFormat='Unit price: {0:N0} ₫'}" FontSize="{DynamicResource CaptionFontSize}" Foreground="{StaticResource OnSurfaceMutedBrush}"/>
              <!-- Quantity stepper -->
              <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Left">
                <Button Content="−" Command="{Binding CustomizationLine.DecrementQtyCommand}" MinWidth="44" MinHeight="44" FontSize="18" Padding="12,8"/>
                <TextBlock Text="{Binding CustomizationLine.Quantity}" FontSize="{DynamicResource BodyFontSize}" FontWeight="SemiBold" Foreground="{StaticResource OnSurfaceBrush}" VerticalAlignment="Center" MinWidth="32" TextAlignment="Center"/>
                <Button Content="+" Command="{Binding CustomizationLine.IncrementQtyCommand}" MinWidth="44" MinHeight="44" FontSize="18" Padding="12,8"/>
              </StackPanel>
              <Border Background="{StaticResource PrimaryLightBrush}" CornerRadius="8" Padding="12,8">
                <TextBlock Text="{Binding CustomizationLine.LineTotal, StringFormat='Line total: {0:N0} ₫'}" FontSize="{DynamicResource BodyFontSize}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
              </Border>
            </StackPanel>
            <!-- Right: Ice, Sugar, Size, Note -->
            <StackPanel Grid.Column="1" Spacing="12" Margin="12,0,0,0">
              <TextBlock Text="Ice" FontSize="{DynamicResource CaptionFontSize}" FontWeight="SemiBold" Foreground="{StaticResource OnSurfaceMutedBrush}"/>
              <ItemsControl ItemsSource="{Binding IceLevels}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="6"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Button Content="{Binding}" Command="{Binding #Root.DataContext.SetCustomizationIceCommand}" CommandParameter="{Binding}"
                            MinHeight="44" Padding="12,10" FontSize="{DynamicResource CaptionFontSize}"
                            Background="{Binding #Root.DataContext.CustomizationLine.IceLevel, Converter={StaticResource EqualityToBrushConverter}, ConverterParameter={Binding}}"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <TextBlock Text="Sugar" FontSize="{DynamicResource CaptionFontSize}" FontWeight="SemiBold" Foreground="{StaticResource OnSurfaceMutedBrush}"/>
              <ItemsControl ItemsSource="{Binding SugarLevels}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="6"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Button Content="{Binding}" Command="{Binding #Root.DataContext.SetCustomizationSugarCommand}" CommandParameter="{Binding}"
                            MinHeight="44" Padding="12,10" FontSize="{DynamicResource CaptionFontSize}"
                            Background="{Binding #Root.DataContext.CustomizationLine.SugarLevel, Converter={StaticResource EqualityToBrushConverter}, ConverterParameter={Binding}}"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <TextBlock Text="Size" FontSize="{DynamicResource CaptionFontSize}" FontWeight="SemiBold" Foreground="{StaticResource OnSurfaceMutedBrush}"/>
              <ItemsControl ItemsSource="{Binding SizeOptions}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="6"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Button Content="{Binding}" Command="{Binding #Root.DataContext.SetCustomizationSizeCommand}" CommandParameter="{Binding}"
                            MinHeight="44" Padding="12,10" FontSize="{DynamicResource CaptionFontSize}"
                            Background="{Binding #Root.DataContext.CustomizationLine.Size, Converter={StaticResource EqualityToBrushConverter}, ConverterParameter={Binding}}"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <TextBlock Text="Note" FontSize="{DynamicResource CaptionFontSize}" FontWeight="SemiBold" Foreground="{StaticResource OnSurfaceMutedBrush}"/>
              <TextBox Text="{Binding CustomizationLine.Note}" Watermark="Special instructions" MinHeight="44"/>
            </StackPanel>
          </Grid>
          <!-- Footer: Add to order (primary) + Close (red), same size, min 48px -->
          <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Stretch">
            <Button Content="Close" Command="{Binding CloseCustomizationCommand}" MinHeight="48" Padding="20,14" Classes="danger" HorizontalAlignment="Left"/>
            <Button Content="Add to order" Command="{Binding ConfirmCustomizationCommand}" MinHeight="48" Padding="20,14" Classes="primary" HorizontalAlignment="Right"
                    IsVisible="{Binding IsPendingAdd}"/>
            <Button Content="Apply" Command="{Binding ConfirmCustomizationCommand}" MinHeight="48" Padding="20,14" Classes="primary" HorizontalAlignment="Right"
                    IsVisible="{Binding !IsPendingAdd}"/>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Overlay: Payment (common ModalOverlay) -->
    <controls:ModalOverlay IsOpen="{Binding IsPaymentOpen}" Title="Payment">
      <StackPanel Spacing="{DynamicResource Spacing16}">
        <TextBlock Text="{Binding CurrentBill.GrandTotal, StringFormat='Total: {0:N0} ₫'}" FontSize="{DynamicResource BodyFontSize}" FontWeight="SemiBold"/>
        <StackPanel Orientation="Horizontal" Spacing="8">
          <TextBox Text="{Binding CouponCode}" Watermark="Coupon code" MinWidth="120"/>
          <Button Content="Apply" Command="{Binding ApplyCouponCommand}" Padding="8,4"/>
        </StackPanel>
        <CheckBox IsChecked="{Binding IsSplitPayment}" Content="Split payment"/>
        <StackPanel IsVisible="{Binding IsSplitPayment}" Spacing="8">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <ComboBox ItemsSource="{Binding PaymentMethods}" SelectedItem="{Binding SelectedPaymentMethod}" MinWidth="80"/>
            <TextBox Text="{Binding PaymentEntryAmount}" Watermark="Amount" MinWidth="100"/>
            <Button Content="Add" Command="{Binding AddPaymentEntryCommand}" Padding="8,4"/>
          </StackPanel>
          <ItemsControl ItemsSource="{Binding PaymentEntries}">
            <ItemsControl.ItemTemplate>
              <DataTemplate DataType="vm:PaymentEntryViewModel">
                <Border Padding="8,4" Margin="0,2" Background="{StaticResource SurfaceBrush}">
                  <Grid ColumnDefinitions="*,Auto,Auto">
                    <TextBlock Grid.Column="0" Text="{Binding Method}" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Text="{Binding Amount, StringFormat='{}{0:N0} ₫'}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                    <Button Grid.Column="2" Content="Remove" Command="{Binding #Root.DataContext.RemovePaymentEntryCommand}" CommandParameter="{Binding}" Padding="4,2"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
          <TextBlock Text="{Binding SplitTotal, StringFormat='Split total: {0:N0} ₫'}" FontSize="{DynamicResource CaptionFontSize}"/>
        </StackPanel>
        <StackPanel IsVisible="{Binding ShowSingleAmount}">
          <TextBlock Text="Amount" FontSize="{DynamicResource CaptionFontSize}"/>
          <TextBox Text="{Binding PaymentAmount}"/>
        </StackPanel>
        <TextBox Text="{Binding TipAmountText}" Watermark="Tip (optional)"/>
        <StackPanel Orientation="Horizontal" Spacing="8">
          <Button Content="Complete" Command="{Binding CompletePaymentCommand}" Padding="16,8" Classes="primary"/>
          <Button Content="Cancel" Command="{Binding CancelPaymentCommand}" Padding="16,8"/>
        </StackPanel>
      </StackPanel>
    </controls:ModalOverlay>

    <!-- Overlay: Void line -->
    <Border IsVisible="{Binding IsVoidLineDialogOpen}" Background="{StaticResource OverlayDimBrush}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ZIndex="100">
      <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="{StaticResource SurfaceBrush}" Padding="{DynamicResource Margin24}"
              CornerRadius="{DynamicResource CornerRadius8}" MinWidth="260">
        <StackPanel Spacing="{DynamicResource Spacing8}">
          <TextBlock Text="Void line - Reason" FontWeight="{StaticResource TitleFontWeight}"/>
          <TextBox Text="{Binding VoidReason}" Watermark="Reason (optional)"/>
          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Content="Confirm void" Command="{Binding ConfirmVoidLineCommand}" Padding="16,8"/>
            <Button Content="Cancel" Command="{Binding CancelVoidLineCommand}" Padding="16,8"/>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Overlay: Merge bill -->
    <Border IsVisible="{Binding IsMergeConfirmOpen}" Background="{StaticResource OverlayDimBrush}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ZIndex="100">
      <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="{StaticResource SurfaceBrush}" Padding="{DynamicResource Margin24}" CornerRadius="{DynamicResource CornerRadius8}" MinWidth="280">
        <StackPanel Spacing="12">
          <TextBlock Text="Merge bill" FontWeight="{StaticResource TitleFontWeight}"/>
          <TextBlock IsVisible="{Binding MergeSourceBill, Converter={x:Static ObjectConverters.IsNotNull}}"
                     Text="Merge selected bill into current? All items will be moved."/>
          <ListBox IsVisible="{Binding MergeSourceBill, Converter={x:Static ObjectConverters.IsNull}}"
                   ItemsSource="{Binding MergeBillCandidates}" MinHeight="100">
            <ListBox.ItemTemplate>
              <DataTemplate DataType="vm:BillViewModel">
                <Button Content="{Binding Label}" Command="{Binding #Root.DataContext.RequestMergeBillCommand}" CommandParameter="{Binding}" HorizontalAlignment="Stretch"/>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
          <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding MergeSourceBill, Converter={x:Static ObjectConverters.IsNotNull}}">
            <Button Content="Confirm" Command="{Binding ConfirmMergeBillCommand}" Classes="primary"/>
            <Button Content="Cancel" Command="{Binding CancelMergeBillCommand}"/>
          </StackPanel>
          <Button Content="Cancel" Command="{Binding CancelMergeBillCommand}" HorizontalAlignment="Right" IsVisible="{Binding MergeSourceBill, Converter={x:Static ObjectConverters.IsNull}}"/>
        </StackPanel>
      </Border>
    </Border>

    <!-- Overlay: Void bill -->
    <Border IsVisible="{Binding IsVoidBillDialogOpen}" Background="{StaticResource OverlayDimBrush}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ZIndex="100">
      <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="{StaticResource SurfaceBrush}" Padding="{DynamicResource Margin24}"
              CornerRadius="{DynamicResource CornerRadius8}" MinWidth="260">
        <StackPanel Spacing="{DynamicResource Spacing8}">
          <TextBlock Text="Void bill - Reason" FontWeight="{StaticResource TitleFontWeight}"/>
          <TextBox Text="{Binding VoidBillReason}" Watermark="Reason (required)"/>
          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Content="Confirm void" Command="{Binding ConfirmVoidBillCommand}" Padding="16,8"/>
            <Button Content="Cancel" Command="{Binding CancelVoidBillCommand}" Padding="16,8"/>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Overlay: Recall held -->
    <Border IsVisible="{Binding IsRecallOpen}" Background="{StaticResource OverlayDimBrush}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ZIndex="100">
      <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="{StaticResource SurfaceBrush}" Padding="{DynamicResource Margin24}"
              CornerRadius="{DynamicResource CornerRadius8}" MinWidth="260">
        <StackPanel Spacing="{DynamicResource Spacing8}">
          <TextBlock Text="Recall held bill" FontWeight="{StaticResource TitleFontWeight}" Margin="0,0,0,8"/>
          <ListBox ItemsSource="{Binding HeldBills}" MinHeight="120">
            <ListBox.ItemTemplate>
              <DataTemplate DataType="vm:BillViewModel">
                <Button Content="{Binding Label}" Command="{Binding $parent[UserControl].DataContext.RecallBillCommand}" CommandParameter="{Binding}" HorizontalAlignment="Stretch"/>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
          <Button Content="Close" Command="{Binding CloseRecallCommand}" HorizontalAlignment="Right" Margin="0,8,0,0"/>
        </StackPanel>
      </Border>
    </Border>

    <!-- Overlay: Customer search -->
    <Border IsVisible="{Binding IsCustomerSearchOpen}" Background="{StaticResource OverlayDimBrush}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ZIndex="100">
      <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="{StaticResource SurfaceBrush}" Padding="{DynamicResource Margin24}" CornerRadius="{DynamicResource CornerRadius8}" MinWidth="320">
        <StackPanel Spacing="{DynamicResource Spacing8}">
          <TextBlock Text="Customer lookup" FontWeight="{StaticResource TitleFontWeight}"/>
          <TextBox Text="{Binding CustomerSearchTerm}" Watermark="Name or phone"/>
          <Button Content="Search" Command="{Binding SearchCustomersCommand}"/>
          <ListBox ItemsSource="{Binding CustomerSearchResults}" MinHeight="180">
            <ListBox.ItemTemplate>
              <DataTemplate DataType="models:Customer">
                <Button Content="{Binding Name}" Command="{Binding #Root.DataContext.SelectCustomerCommand}" CommandParameter="{Binding}" HorizontalAlignment="Stretch"/>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
          <Button Content="Close" Command="{Binding CloseCustomerSearchCommand}"/>
        </StackPanel>
      </Border>
    </Border>

    <!-- Overlay: New customer -->
    <Border IsVisible="{Binding IsNewCustomerOpen}" Background="{StaticResource OverlayDimBrush}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ZIndex="100">
      <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="{StaticResource SurfaceBrush}" Padding="{DynamicResource Margin24}" CornerRadius="{DynamicResource CornerRadius8}" MinWidth="280">
        <StackPanel Spacing="{DynamicResource Spacing8}">
          <TextBlock Text="New customer" FontWeight="{StaticResource TitleFontWeight}"/>
          <TextBox Text="{Binding NewCustomerName}" Watermark="Name"/>
          <TextBox Text="{Binding NewCustomerPhone}" Watermark="Phone *"/>
          <TextBox Text="{Binding NewCustomerEmail}" Watermark="Email"/>
          <TextBox Text="{Binding NewCustomerAddress}" Watermark="Address"/>
          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Content="Save" Command="{Binding SaveNewCustomerCommand}"/>
            <Button Content="Cancel" Command="{Binding CloseNewCustomerCommand}"/>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Overlay: Redeem points -->
    <Border IsVisible="{Binding IsRedeemPointsOpen}" Background="{StaticResource OverlayDimBrush}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ZIndex="100">
      <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="{StaticResource SurfaceBrush}" Padding="{DynamicResource Margin24}" CornerRadius="{DynamicResource CornerRadius8}" MinWidth="260">
        <StackPanel Spacing="{DynamicResource Spacing8}">
          <TextBlock Text="Redeem points" FontWeight="{StaticResource TitleFontWeight}"/>
          <TextBox Text="{Binding PointsToRedeemText}" Watermark="Points to redeem"/>
          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Content="Apply" Command="{Binding ConfirmRedeemPointsCommand}"/>
            <Button Content="Cancel" Command="{Binding CloseRedeemPointsCommand}"/>
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>
  </Grid>
</UserControl>
